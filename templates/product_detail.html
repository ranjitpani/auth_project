{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.name }}{% endblock %}
{% block content %}

<style>
/* ===== PAGE ===== */
.page-wrap{
  padding:0 12px;
  overflow-x:hidden;
}

/* ===== FLIPKART IMAGE SCROLL ===== */
.image-scroll{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  gap:10px;
  padding:10px 0;
}
.image-scroll::-webkit-scrollbar{
  display:none;
}
.image-item{
  min-width:100%;
  scroll-snap-align:start;
  background:#f5f5f5;
  display:flex;
  justify-content:center;
}
.product-img{
  width:100%;
  height:340px;
  object-fit:contain;
}

/* ===== TEXT ===== */
.product-title{
  font-size:18px;
  font-weight:600;
  margin-top:10px;
}
.product-desc{
  font-size:14px;
  color:#555;
}

/* ===== PRICE ===== */
.price-main{
  font-size:22px;
  font-weight:700;
}
.price-cut{
  text-decoration:line-through;
  color:#777;
  margin-right:6px;
}

/* ===== SIZE ===== */
.size-btn{
  min-width:52px;
  padding:10px 14px;
  border-radius:10px;
  font-weight:600;
}
.size-btn.active{
  background:#2874f0;
  color:#fff;
}

/* ===== BOTTOM BAR ===== */
.action-bar{
  position:sticky;
  bottom:0;
  background:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  box-shadow:0 -3px 12px rgba(0,0,0,.12);
}
.btn-cart,.btn-buy{
  width:48%;
  font-size:16px;
  font-weight:700;
  padding:14px;
  border-radius:14px;
}
.btn-cart{background:#ff9f00;color:#fff;}
.btn-buy{background:#fb641b;color:#fff;}
</style>

<div class="page-wrap">

  <!-- IMAGE SIDE SCROLL -->
  <div class="image-scroll">
  {% for img in product.images.all %}
    <div class="image-item">

      {% if img.image_url %}
        <!-- LIVE (Cloudinary) -->
        <img src="{{ img.image_url }}" class="product-img">

      {% elif img.image %}
        <!-- LOCAL -->
        <img src="{{ img.image.url }}" class="product-img">

      {% else %}
        <img src="{% static 'default_product.jpg' %}" class="product-img">
      {% endif %}

    </div>
  {% empty %}
    <div class="image-item">
      <img src="{% static 'default_product.jpg' %}" class="product-img">
    </div>
  {% endfor %}
</div>

  <!-- PRODUCT INFO -->
  <div>
    <div class="product-title">{{ product.name }}</div>
    <div class="product-desc">{{ product.description }}</div>

    {% if product.discounted_price %}
      <span class="price-cut">â‚¹ {{ product.price }}</span>
      <span class="price-main">â‚¹ {{ product.discounted_price }}</span>
    {% else %}
      <span class="price-main">â‚¹ {{ product.price }}</span>
    {% endif %}
  </div>
     <!--size-->
     <div class="mt-3">
  <b>Select Size</b><br>
  {% for stock in product.stocks.all %}
    <a href="{% url 'add_to_cart' product.id stock.size %}" class="btn btn-outline-secondary size-btn">
      {{ stock.size }}
    </a>
  {% endfor %}
</div>

<div class="action-bar">
  {% if product.stocks.exists %}
    <a href="{% url 'add_to_cart' product.id product.stocks.first.size %}" class="btn btn-cart">ðŸ›’ Add to Cart</a>
    <a href="{% url 'buy_now' product.id product.stocks.first.size %}" class="btn btn-buy">ðŸ’³ Buy Now</a>
  {% else %}
    <button class="btn btn-cart" disabled>Out of Stock</button>
    <button class="btn btn-buy" disabled>Out of Stock</button>
  {% endif %}
</div>



<!-- SIMILAR PRODUCTS -->
<div class="mt-4">
  <h5 class="fw-bold mb-2">Similar Products</h5>

  <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:6px;">
    {% for p in similar_products %}
    <a href="{% url 'product_detail' p.id %}" style="text-decoration:none;color:inherit;">
      <div style="
        min-width:140px;
        border:1px solid #eee;
        border-radius:10px;
        padding:8px;
        background:#fff;
      ">
        {% if p.images.first %}
  {% if p.images.first.image_url %}
    <img src="{{ p.images.first.image_url }}"
         style="width:100%;height:120px;object-fit:contain;">
  {% else %}
    <img src="{{ p.images.first.image.url }}"
         style="width:100%;height:120px;object-fit:contain;">
  {% endif %}
{% else %}
  <img src="{% static 'default_product.jpg' %}"
       style="width:100%;height:120px;object-fit:contain;">
{% endif %}

        <div style="font-size:13px;font-weight:600;margin-top:4px;">
          {{ p.name|truncatechars:18 }}
        </div>

        <div style="font-size:14px;font-weight:700;">
          â‚¹ {{ p.discounted_price|default:p.price }}
        </div>
      </div>
    </a>
    {% empty %}
      <p>No similar products</p>
    {% endfor %}
  </div>
</div>

<script>
let selectedSize = null;

// Handle size button click
document.querySelectorAll('.size-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    e.preventDefault();
    // Remove active from all buttons
    document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active'));
    // Add active to clicked button
    btn.classList.add('active');
    // Set selected size
    selectedSize = btn.innerText.trim();
    // Update Add to Cart and Buy Now buttons
    document.querySelector('.btn-cart').href = `/add-to-cart/{{ product.id }}/` + selectedSize + '/';
    document.querySelector('.btn-buy').href = `/buy-now/{{ product.id }}/` + selectedSize + '/';
  });
});

// Handle Add to Cart click
document.querySelector('.btn-cart').addEventListener('click', e=>{
  if(!selectedSize){
    e.preventDefault();
    alert('Please select a size first!');
  }
});

// Handle Buy Now click
document.querySelector('.btn-buy').addEventListener('click', e=>{
  if(!selectedSize){
    e.preventDefault();
    alert('Please select a size first!');
  }
});
</script>
{% endblock %}