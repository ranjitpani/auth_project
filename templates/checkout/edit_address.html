{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Delivery Address</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#eef2ff;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}
.form-box{
  padding:20px;
  background:#fff;
  min-height:100vh;
}
@media(min-width:768px){
  .form-box{
    max-width:420px;
    margin:30px auto;
    border-radius:18px;
    box-shadow:0 15px 35px rgba(0,0,0,.1);
  }
}
input,textarea{
  width:100%;
  padding:16px;
  margin-bottom:14px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  font-size:15px;
}
.row{display:flex;gap:10px}
.row input{flex:1}
.btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  font-size:16px;
  font-weight:800;
}
.btn-primary{
  background:linear-gradient(135deg,#2563eb,#1e40af);
  color:#fff;
}
.btn-location{
  background:#eef2ff;
  border:2px dashed #c7d2fe;
  color:#1e40af;
  margin-bottom:12px;
}
.map-box{
  height:260px;
  border-radius:16px;
  overflow:hidden;
  margin-bottom:12px;
}
.note{
  font-size:12px;
  color:#64748b;
  margin-bottom:10px;
}
.search-wrap{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.search-wrap input{flex:1}
.search-wrap button{
  padding:0 18px;
  border:none;
  border-radius:14px;
  background:#2563eb;
  color:#fff;
  font-weight:700;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

{% include "checkout/steps.html" with step=1 %}

<form method="post" class="form-box">
{% csrf_token %}

<input name="name" value="{{ address.name }}" placeholder="Full Name" required>
<input name="mobile" value="{{ address.mobile }}" placeholder="Mobile Number" required maxlength="10">
<input name="alt_mobile" value="{{ address.alt_mobile }}" placeholder="Alternate Mobile">

<input name="pincode" id="pincode" value="{{ address.pincode }}" placeholder="Pincode" required>

<div class="row">
  <input name="state" id="state" value="{{ address.state }}" placeholder="State">
  <input name="district" id="district" value="{{ address.district }}" placeholder="District">
</div>

<input name="block" id="block" value="{{ address.block }}" placeholder="Block">
<input name="village" id="village" value="{{ address.village }}" placeholder="Village">
<input name="room_no" value="{{ address.room_no }}" placeholder="House / Room No">

<textarea name="address" id="address" placeholder="Street / Landmark" required>
{{ address.address }}
</textarea>

<input type="hidden" name="latitude" id="lat" value="{{ address.latitude }}">
<input type="hidden" name="longitude" id="lng" value="{{ address.longitude }}">

<p class="note">üîç Search / tap map / current location</p>

<div class="search-wrap">
  <input type="text" id="searchBox" placeholder="Search village, city, landmark">
  <button type="button" onclick="searchLocation()">Search</button>
</div>

<div class="map-box" id="map"></div>

<button type="button" class="btn btn-location" onclick="useMyLocation()">
üìç Use My Current Location
</button>

<button type="submit" class="btn btn-primary">
Update Address ‚Üí
</button>

</form>

<script>
let map, marker;

/* INIT MAP WITH EXISTING LOCATION */
document.addEventListener("DOMContentLoaded",()=>{
  const lat = parseFloat("{{ address.latitude|default:'20.5937' }}");
  const lng = parseFloat("{{ address.longitude|default:'78.9629' }}");
  const zoom = lat && lng ? 16 : 5;

  map = L.map("map").setView([lat,lng],zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
    attribution:"&copy; OpenStreetMap"
  }).addTo(map);

  marker = L.marker([lat,lng],{draggable:true}).addTo(map);

  map.on("click",e=>{
    marker.setLatLng(e.latlng);
    setLatLng(e.latlng.lat,e.latlng.lng);
    reverseGeocode(e.latlng.lat,e.latlng.lng);
  });

  marker.on("dragend",()=>{
    const p = marker.getLatLng();
    setLatLng(p.lat,p.lng);
    reverseGeocode(p.lat,p.lng);
  });

  searchBox.addEventListener("keydown",e=>{
    if(e.key==="Enter"){e.preventDefault(); searchLocation();}
  });
});

/* SEARCH LOCATION */
function searchLocation(){
  let q = searchBox.value.trim();
  if(!q){alert("Village / location lekha");return;}
  const queries = [
    q,
    `${q}, ${block.value}`,
    `${q}, ${district.value}`,
    `${q}, ${state.value}`,
    `${q}, India`
  ];
  searchFallback(queries,0);
}

function searchFallback(queries,i){
  if(i>=queries.length){
    alert("Location mililani, try district/state");
    return;
  }
  fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(queries[i])}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.length){searchFallback(queries,i+1);return;}
    const lat=parseFloat(d[0].lat);
    const lng=parseFloat(d[0].lon);
    map.setView([lat,lng],16);
    marker.setLatLng([lat,lng]);
    setLatLng(lat,lng);
    reverseGeocode(lat,lng);
  });
}

/* SET LAT LNG */
function setLatLng(lat,lng){
  latInput.value = lat.toFixed(6);
  lngInput.value = lng.toFixed(6);
}
const latInput=document.getElementById("lat");
const lngInput=document.getElementById("lng");

/* CURRENT LOCATION */
function useMyLocation(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    map.setView([lat,lng],16);
    marker.setLatLng([lat,lng]);
    setLatLng(lat,lng);
    reverseGeocode(lat,lng);
  });
}

/* REVERSE GEOCODE */
function reverseGeocode(lat,lng){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.address) return;
    const a=d.address;
    pincode.value=a.postcode||"";
    state.value=a.state||"";
    district.value=a.state_district||a.district||"";
    block.value=a.county||a.suburb||"";
    village.value=a.village||a.town||a.city||"";
  });
}
</script>

</body>
</html>