<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Address</title>

<style>
*{
  box-sizing:border-box;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

body{
  margin:0;
  background:#f4f6fb;
}

.page{
  padding:16px;
  padding-bottom:120px;
  animation:fadeUp .3s ease;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.card{
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 12px 26px rgba(0,0,0,.08);
}

h3{
  margin:0 0 14px;
  font-size:18px;
  font-weight:800;
  color:#0f172a;
}

.form-group{
  margin-bottom:14px;
}

label{
  display:block;
  font-size:13px;
  font-weight:700;
  color:#475569;
  margin-bottom:6px;
}

input, textarea{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1.6px solid #e2e8f0;
  font-size:15px;
  outline:none;
  transition:.2s;
}

textarea{
  min-height:90px;
  resize:none;
}

input:focus,
textarea:focus{
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,.12);
}

.row{
  display:flex;
  gap:12px;
}

.row .form-group{
  flex:1;
}

.fixed-bottom{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  padding:14px 16px;
  box-shadow:0 -8px 22px rgba(0,0,0,.15);
}

.save-btn{
  width:100%;
  padding:16px;
  border-radius:18px;
  border:none;
  font-size:16px;
  font-weight:900;
  color:#fff;
  background:linear-gradient(135deg,#2563eb,#1e40af);
  cursor:pointer;
}

.save-btn:active{
  transform:scale(.98);
}

@media(min-width:768px){
  .page{
    max-width:520px;
    margin:20px auto;
  }
}
</style>
</head>

<body>

<div class="page">
  <div class="card">
    <h3>Edit Delivery Address</h3>

    <form method="post">
      {% csrf_token %}

      <div class="form-group">
        <label>Full Name</label>
        <input type="text" name="name" value="{{ address.name }}" required>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Mobile Number</label>
          <input type="tel" name="mobile" value="{{ address.mobile }}" required>
        </div>

        <div class="form-group">
          <label>Alternate Mobile</label>
          <input type="tel" name="alt_mobile" value="{{ address.alt_mobile }}">
        </div>
      </div>

      <div class="form-group">
  <label>Pincode</label>
  <input type="text" name="pincode" id="pincode"
         value="{{ address.pincode }}" required>

  <!-- loader + error -->
  <p id="pin-loader" style="display:none;font-size:13px;color:#2563eb;margin-top:6px;">
    üîÑ Fetching location‚Ä¶
  </p>
  <p id="pin-error" style="display:none;font-size:13px;color:#dc2626;margin-top:6px;">
    ‚ùå Invalid pincode
  </p>
</div>

      <div class="row">
        <div class="form-group">
          <label>State</label>
          <input type="text" name="state" id="state" value="{{ address.state }}" required>
        </div>

        <div class="form-group">
          <label>District</label>
          <input type="text" name="district" id="district" value="{{ address.district }}" required>
        </div>
      </div>

      <div class="form-group">
        <label>Village / Block</label>
        <input type="text" name="block" id="block" value="{{ address.block }}" required>
      </div>
      <input type="hidden" name="latitude" id="latitude" value="{{ address.latitude }}">
      <input type="hidden" name="longitude" id="longitude" value="{{ address.longitude }}">
      <button type="button"
        onclick="getLocation()"
        style="
          width:100%;
          margin-top:6px;
          padding:12px;
          border-radius:14px;
          border:2px dashed #c7d2fe;
          background:#eef2ff;
          color:#1e40af;
          font-weight:700;
          cursor:pointer;">
  üìç Use My Current Location
</button>
<p style="font-size:12px;color:#64748b;margin-top:6px;">
  üìç Location is approximate. Please verify address before saving.
</p>
 
      <div class="form-group">
        <label>Full Address</label>
        <textarea name="address" required>{{ address.address }}</textarea>
      </div>

      <!-- bottom fixed button -->
      <div class="fixed-bottom">
        <button type="submit" class="save-btn">
          Save & Continue ‚Üí
        </button>
      </div>

    </form>
  </div>
</div>

<script>
/* -------- PINCODE AUTO FILL (INDIA POST API) -------- */
document.getElementById("pincode").addEventListener("blur", function () {
  const pin = this.value.trim();

  if (pin.length !== 6 || isNaN(pin)) return;

  fetch(`https://api.postalpincode.in/pincode/${pin}`)
    .then(res => res.json())
    .then(data => {
      if (data[0].Status !== "Success") return;

      const postOffice = data[0].PostOffice[0];

      document.getElementById("state").value =
        postOffice.State || "";

      document.getElementById("district").value =
        postOffice.District || "";

      document.getElementById("block").value =
        postOffice.Block || postOffice.Name || "";
    })
    .catch(err => console.log("Pincode error:", err));
});


const pincodeInput = document.getElementById("pincode");
const stateInput = document.getElementById("state");
const districtInput = document.getElementById("district");
const blockInput = document.getElementById("block");

const loader = document.getElementById("pin-loader");
const errorMsg = document.getElementById("pin-error");

/* ---------- PINCODE AUTO FILL ---------- */
pincodeInput.addEventListener("blur", function () {
  const pin = this.value.trim();

  loader.style.display = "none";
  errorMsg.style.display = "none";

  if (pin.length !== 6 || isNaN(pin)) {
    errorMsg.style.display = "block";
    return;
  }

  loader.style.display = "block";

  fetch(`https://api.postalpincode.in/pincode/${pin}`)
    .then(res => res.json())
    .then(data => {
      loader.style.display = "none";

      if (data[0].Status !== "Success") {
        errorMsg.style.display = "block";
        return;
      }

      const p = data[0].PostOffice[0];
      stateInput.value = p.State || "";
      districtInput.value = p.District || "";
      blockInput.value = p.Block || p.Name || "";
    })
    .catch(() => {
      loader.style.display = "none";
      errorMsg.style.display = "block";
    });
});

document.querySelector("form").addEventListener("submit", function(e){
  const lat = document.getElementById("latitude").value;
  const lng = document.getElementById("longitude").value;

  if (lat && lng) return; // already present

  e.preventDefault();

  const fullAddress = `
    ${document.querySelector("textarea[name='address']").value},
    ${block.value},
    ${district.value},
    ${state.value},
    India
  `;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        alert("Unable to detect location");
        return;
      }
      document.getElementById("latitude").value = data[0].lat;
      document.getElementById("longitude").value = data[0].lon;
      e.target.submit();
    });
});

/* ---------- GPS LOCATION ---------- */

function getLocation() {
  if (!navigator.geolocation) {
    alert("Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function(pos){
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // üî• SAVE INTO FORM
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lng;

      // OPTIONAL: reverse geocode for UI
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(res => res.json())
        .then(data => {
          if (!data.address) return;
          const a = data.address;
          document.getElementById("state").value = a.state || "";
          document.getElementById("district").value =
            a.state_district || a.county || "";
          document.getElementById("block").value =
            a.village || a.suburb || a.town || "";
          if (a.postcode) {
            document.getElementById("pincode").value = a.postcode;
          }
        });
    },
    function(){
      alert("Location permission denied");
    },
    { enableHighAccuracy: true }
  );
}


</script>

</body>
</html>