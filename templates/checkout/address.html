{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Address</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: linear-gradient(180deg, #eef2ff, #ffffff);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

.form-box {
  width: 100%;
  min-height: 100vh;
  background: #ffffff;
  padding: 20px 18px 30px;
  animation: slideUp 0.4s ease;
}

@media (min-width: 768px) {
  .form-box {
    max-width: 420px;
    margin: 30px auto;
    border-radius: 18px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    min-height: auto;
  }
}

@keyframes slideUp {
  from { transform: translateY(25px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.form-box input,
.form-box textarea {
  width: 100%;
  padding: 18px 16px;
  margin-bottom: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  font-size: 16px;
  background: #f9fafb;
}

.form-box input:focus,
.form-box textarea:focus {
  border-color: #2563eb;
  background: #fff;
  outline: none;
  box-shadow: 0 0 0 4px rgba(37,99,235,0.18);
}

.row {
  display: flex;
  gap: 12px;
}

.row input { flex: 1; }

@media (max-width: 640px) {
  .row { flex-direction: column; }
}

.btn {
  width: 100%;
  padding: 18px;
  border: none;
  border-radius: 18px;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
}

.btn-primary {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: #fff;
  box-shadow: 0 10px 25px rgba(37,99,235,0.35);
}

.btn-location {
  background: #eef2ff;
  color: #1e40af;
  border: 2px dashed #c7d2fe;
  margin-bottom: 12px;
}

.note {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 12px;
}
</style>
</head>

<body>

{% include "checkout/steps.html" with step=1 %}

<form method="post" action="{% url 'save_address' %}" class="form-box">
  {% csrf_token %}

  <input name="name" placeholder="Full Name" required pattern="[A-Za-z ]+">
  <input name="mobile" placeholder="Mobile Number" required maxlength="10" pattern="[0-9]{10}">
  <input name="alt_mobile" placeholder="Alternate Mobile (optional)" maxlength="10" pattern="[0-9]{10}">
  <input name="pincode" id="pincode" placeholder="Pincode" required maxlength="6" pattern="[0-9]{6}">

  <div class="row">
    <input name="state" id="state" placeholder="State">
    <input name="district" id="district" placeholder="District">
  </div>

  <input name="block" id="block" placeholder="Village / Block">

  <textarea
    name="address"
    id="address"
    placeholder="Full Address (House No, Street, Village, Landmark)"
    rows="4"
    required></textarea>

  <!-- üî• REQUIRED FOR KM CALCULATION -->
  <input type="hidden" name="latitude" id="lat">
  <input type="hidden" name="longitude" id="lng">

  <p class="note">
    üìç Location is auto-detected and may not be 100% accurate. Please verify before saving.
  </p>

  <button type="button" class="btn btn-location" onclick="getLocation()">
    üìç Use My Current Location
  </button>

  <button type="submit" class="btn btn-primary">
    Save & Continue ‚Üí
  </button>
</form>

<script>
/* -------- PINCODE AUTO FILL -------- */
document.getElementById("pincode").addEventListener("blur", function () {
  const pin = this.value;
  if (pin.length !== 6) return;

  fetch(`https://api.postalpincode.in/pincode/${pin}`)
    .then(res => res.json())
    .then(data => {
      if (data[0].Status !== "Success") return;
      const p = data[0].PostOffice[0];
      state.value = p.State || "";
      district.value = p.District || "";
      block.value = p.Block || p.Name || "";
    });
});

/* -------- AUTO LOCATION ON PAGE LOAD -------- */
window.onload = function () {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById("lat").value = pos.coords.latitude;
      document.getElementById("lng").value = pos.coords.longitude;
    },
    () => {},
    { enableHighAccuracy: true }
  );
};

/* -------- LOCATION BUTTON -------- */

function getLocation() {
  if (!navigator.geolocation) {
    alert("Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // üî• IMPORTANT: hidden fields fill
      document.getElementById("lat").value = lat;
      document.getElementById("lng").value = lon;

      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&zoom=18`)
        .then(res => res.json())
        .then(data => {
          if (!data.address) return;
          const a = data.address;

          state.value = a.state || state.value;
          district.value = a.state_district || a.county || district.value;
          block.value = a.village || a.suburb || a.town || block.value;

          if (a.postcode) pincode.value = a.postcode;

          address.value =
`${a.house_number || ""}
${a.road || ""}
${a.suburb || ""}
${a.village || a.town || ""}`.trim();
        });
    },
    () => alert("Location permission denied"),
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}
</script>

</body>
</html>