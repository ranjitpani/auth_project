{% include "checkout/steps.html" with step=1 %}
<style>
body {
  background: linear-gradient(180deg, #f1f5ff, #ffffff);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Card */
.form-box {
  background: #ffffff;
  padding: 18px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  animation: slideUp 0.4s ease;
}

@keyframes slideUp {
  from {transform: translateY(20px); opacity:0}
  to {transform: translateY(0); opacity:1}
}

/* Inputs */
.form-box input,
.form-box textarea {
  width: 100%;
  padding: 14px;
  margin-bottom: 14px;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  font-size: 15px;
  background: #f9fafb;
}

.form-box input:focus,
.form-box textarea:focus {
  border-color: #2563eb;
  background: #fff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
}

/* Row */
.row {
  display: flex;
  gap: 10px;
}
.row input {
  flex: 1;
}

/* Buttons */
.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

/* Primary */
.btn-primary {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: #fff;
  box-shadow: 0 8px 18px rgba(37,99,235,0.35);
}

.btn-primary:active {
  transform: scale(0.98);
}

/* Location Button */
.btn-location {
  background: #eef2ff;
  color: #1e40af;
  border: 1px dashed #c7d2fe;
  margin-bottom: 14px;
}

.btn-location:hover {
  background: #e0e7ff;
}

/* Mobile */
@media (max-width: 600px) {
  .row {
    flex-direction: column;
  }
}
</style>

<form method="post" action="{% url 'save_address' %}" class="form-box">
{% csrf_token %}

<input name="name" placeholder="Full Name"
       required pattern="[A-Za-z ]+">

<input name="mobile" placeholder="Mobile Number"
       required maxlength="10" pattern="[0-9]{10}">

<input name="alt_mobile" placeholder="Alternate Mobile (optional)"
       maxlength="10" pattern="[0-9]{10}">

<input name="pincode" id="pincode"
       placeholder="Pincode"
       required maxlength="6" pattern="[0-9]{6}"
       onkeyup="fetchPincode(this.value)">

<div class="row">
  <input name="state" id="state" placeholder="State" readonly>
  <input name="district" id="district" placeholder="District" readonly>
</div>

<input name="block" id="block" placeholder="Village / Block" readonly>

<textarea name="address" id="address"
          placeholder="Full Address (AT / PO / Village)"
          rows="4" required></textarea>

<button type="button" class="btn btn-location" onclick="getLocation()">
üìç Use My Current Location
</button>

<button type="submit" class="btn btn-primary">
Save & Continue ‚Üí
</button>
</form>
<script>
function getLocation(){
  if (!navigator.geolocation){
    alert("Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=en`)
      .then(res => res.json())
      .then(data => {
        if(!data.address) return;

        const a = data.address;

        /* -------- SMART FALLBACKS -------- */
        const house =
          a.house_number || "";

        const road =
          a.road || a.residential || "";

        const village =
          a.village ||
          a.hamlet ||
          a.suburb ||
          a.town ||
          a.city ||
          "";

        const post =
          a.post_office ||
          a.village ||
          a.hamlet ||
          "";

        const block =
          a.county ||
          a.subdistrict ||
          a.town ||
          "";

        const district =
          a.state_district ||   // ‚úÖ correct district (Khordha)
          a.district ||
          "";

        const state = a.state || "";
        const country = a.country || "";
        const pincode = a.postcode || "";

        /* -------- ADDRESS FORMAT -------- */
        const addressText =
`AT: ${house ? house + ", " : ""}${road}
PO: ${post}
Village: ${village}
Block: ${block}
District: ${district}
State: ${state}
Country: ${country}
Pincode: ${pincode}`;

        document.getElementById("address").value = addressText;
        document.getElementById("state").value = state;
        document.getElementById("district").value = district;
        document.getElementById("block").value = village || block;

        if(pincode){
          document.getElementById("pincode").value = pincode;
        }
      });
    },
    () => alert("Location permission denied")
  );
}
</script>